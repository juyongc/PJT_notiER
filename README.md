# 환율 알림 서비스

> 환율 확인 및 환율 지정가 알림, 할인 쿠폰 발행 데모 서비스

환율 확인 및 알림 받고 싶은 환율 지정가를 입력하면 해당 알림을 실시간으로 받을 수 있는 데모 서비스

1. 원하는 국가 환율 확인
2. 지정한 환율 알림 받기
3. 통화별 환전 우대 쿠폰 발행

## 프로젝트 진행 소개

- 개인 프로젝트

- 프로젝트 기간: 2024.03 -

- 활용 기술

  Spring boot, Spring Data JPA, MySQL, Redis, Kafka

## 개발 내용

### **할인 쿠폰 발급 동시성 제어**

- **문제점**

    - 많은 유저가 동시에 쿠폰을 발급받으면서 제한된 쿠폰 수보다 더 많은 쿠폰이 발급되는 문제 발생

- **해결방안**

  1.**Optimistic Lock 사용**

  ​ 유저 수가 증가하면서 충돌 빈도가 높아져 성능이 저하되는 문제가 발생했다

  2.**Redis(Redisson) 분산락 도입**

  ​ 가끔 제어가 제대로 되지 않는 경우가 발생했다.

  ​ MySQL 로그를 분석해본 결과, 락 해제와 트랜잭션 커밋 사이의 타이밍 이슈로 인해 동시성 제어가 제대로 이루어지지 않는 것 같다

  3-1.**트랜잭션 분리(전파 전략 REQUIRES_NEW) + Redis 분산락 사용**

  ​ 트랜잭션 커밋 이후에 락이 해제될 수 있도록 별도의 트랜잭션으로 만들자 제어가 제대로 됐다.

  ​ 하지만 유저 수가 늘어나니 데드락이 발생했다.

  ​ DBCP max값 설정을 늘려 데드락을 해결했지만 근본적인 문제 해결책이 아니라 생각됐다.

  3-2.**트랜잭션 분리 + Redis 분산락 사용**

  ​ 생각한 방법은 필요한 부분만 트랜잭션을 거는 방법이었다.

  ​ 지금까진 메서드에 트랜잭션을 거는 걸 당연하게 생각하고 있었는데 굳이 롤백을 하거나 하나로 묶일 필요가 없는데 묶고 있다는 생각이 들었다.

  ​ 꼭 필요한 부분만 트랜잭션을 거니 REQUIRES_NEW로 트랜잭션을 새로 만들 필요가 없어졌다.

  ​ 이 방법으로 동시성 제어를 완료했다.

### 확장성과 유연성 위한 Kafka 기반의 이벤트 드라이븐 구조 설계

- 환율 변동에 따른 사용자 지정가 알람 전송 이벤트 드라이븐 구조로 개발

### 매분마다 국가별 환율 갱신

- spring batch를 사용해서 배치성으로 매분 환율 api로 국가별 환율 갱신 구현

### 하루 한번 지정가 알림 전송

- 지정한 가격대에 오면 하루에 한번만 알림 전송할 수 있게 구현
- Redis를 활용해서 유저에게 금일 알림 전송 여부 확인 후 전송해서 DB 부하 감소

### Spring AOP 활용한 글로벌 예외 처리 구현 및 slack 알람 전송 구축

- Spring AOP로 특정 에러 발생 시, 슬랙에 자동으로 에러 메시지 전송

## 구조도

![구조도](https://github.com/user-attachments/assets/1b7de649-55d0-43cf-8b2d-8737c02a0b9b)